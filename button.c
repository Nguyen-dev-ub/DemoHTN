
#include <wiringPi.h>
#include <stdio.h>
#include <unistd.h>
#include <wiringPiSPI.h>
#include <stdint.h> 
#include <softPwm.h>
#define spi0 0
#define red 11
#define green 12
#define blue 13
#define bt1 15
#define bt2 22
#define bt3 18
#define bt4 16
#define PWM_MAX 100
int num;
uint8_t buff[2];

uint8_t ngang [8][8] = {
    {0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    {0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00},
    {0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00},
    {0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00},
    {0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00},
    {0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00},
    {0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00},
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF}
};

uint8_t heartbit [8] = {0x66,0x99,0x81,0x81,0x81,0x42,0x24,0x18};

int8_t digits[10][8] = {
    {0x1C,0x22,0x22,0x26,0x2A,0x32,0x22,0x1C}, // 0
    {0x08,0x18,0x28,0x08,0x08,0x08,0x08,0x3E}, // 1
    {0x1C,0x22,0x02,0x04,0x08,0x10,0x20,0x3E}, // 2
    {0x1C,0x22,0x02,0x1C,0x02,0x02,0x22,0x1C}, // 3
    {0x04,0x08,0x10,0x24,0x3E,0x04,0x04,0x04}, // 4
    {0x3E,0x20,0x20,0x3C,0x02,0x02,0x22,0x1C}, // 5
    {0x1C,0x20,0x20,0x1C,0x22,0x22,0x22,0x1C}, // 6
    {0x3E,0x02,0x04,0x04,0x08,0x08,0x08,0x08}, // 7
    {0x1C,0x22,0x22,0x1C,0x22,0x22,0x22,0x1C}, // 8
    {0x1C,0x22,0x22,0x1E,0x02,0x02,0x22,0x1C}  // 9
};

uint8_t human [8] = {0x08,0x95,0x89,0xFF,0x08,0x3E,0x2A,0x2A};

uint8_t letters[26][8] = {
    {0x1C,0x22,0x22,0x22,0x3E,0x22,0x22,0x22}, // A
    {0x3C,0x22,0x22,0x3C,0x22,0x22,0x22,0x3C}, // B
    {0x1C,0x22,0x20,0x20,0x20,0x20,0x22,0x1C}, // C
    {0x3C,0x22,0x22,0x22,0x22,0x22,0x22,0x3C}, // D
    {0x3E,0x20,0x20,0x3C,0x20,0x20,0x20,0x3E}, // E
    {0x3E,0x20,0x20,0x3C,0x20,0x20,0x20,0x20}, // F
    {0x1C,0x22,0x20,0x20,0x26,0x22,0x22,0x1C}, // G
    {0x22,0x22,0x22,0x3E,0x22,0x22,0x22,0x22}, // H
    {0x3E,0x08,0x08,0x08,0x08,0x08,0x08,0x3E}, // I
    {0x02,0x02,0x02,0x02,0x02,0x22,0x22,0x1C}, // J
    {0x22,0x24,0x28,0x30,0x28,0x24,0x22,0x22}, // K
    {0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x3E}, // L
    {0x22,0x36,0x2A,0x2A,0x22,0x22,0x22,0x22}, // M
    {0x22,0x22,0x32,0x2A,0x26,0x22,0x22,0x22}, // N
    {0x1C,0x22,0x22,0x22,0x22,0x22,0x22,0x1C}, // O
    {0x3C,0x22,0x22,0x3C,0x20,0x20,0x20,0x20}, // P
    {0x1C,0x22,0x22,0x22,0x2A,0x24,0x1A,0x02}, // Q
    {0x3C,0x22,0x22,0x3C,0x28,0x24,0x22,0x22}, // R
    {0x1C,0x22,0x20,0x1C,0x02,0x02,0x22,0x1C}, // S
    {0x3E,0x08,0x08,0x08,0x08,0x08,0x08,0x08}, // T
    {0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x1C}, // U
    {0x22,0x22,0x22,0x22,0x22,0x22,0x14,0x08}, // V
    {0x22,0x22,0x22,0x2A,0x2A,0x36,0x22,0x22}, // W
    {0x22,0x22,0x14,0x08,0x08,0x14,0x22,0x22}, // X
    {0x22,0x22,0x14,0x08,0x08,0x08,0x08,0x08}, // Y
    {0x3E,0x02,0x04,0x08,0x10,0x20,0x20,0x3E}  // Z
};

void send_data(uint8_t address, uint8_t data){
    buff[0] = address;
    buff[1] = data;
    wiringPiSPIDataRW(spi0, buff, 2);
}

void displayHeart(uint8_t heart[8]){
    for (int i = 0; i < 8; i++) {
        send_data(i + 1, heart[i]);
    }
}

void displayHuman(uint8_t human[8]){
    for (int i = 0; i < 8; i++) {
        send_data(i + 1, human[i]);
    }
}

void displayLetter(char ch) {
    if (ch < 'A' || ch > 'Z') return;  
    int index = ch - 'A';  
    for (int i = 0; i < 8; i++) {
        send_data(i + 1, letters[index][i]);
    }
}

void displayDigit(int num) {
    if (num < 0 || num > 9) return;
    for (int i = 0; i < 8; i++) {
        send_data(i + 1, digits[num][i]);
    }
}

void displayNgang(int row[],int size) {
    uint8_t rowState[8] = {0};
    for (int i = 0; i < size; i++) {
        if (row[i] >= 1 && row[i] <= 8) {
            rowState[row[i] - 1] = 0xFF; 
        }
    }}

void init_max7219(void){
    // decode mode: use code B for all digits -> 0x09FF
    send_data(0x09, 0x00);
    // intensity: 70% --> 0x0A0B
    send_data(0x0A, 0x01);
    // scan limit
    send_data(0x0B, 7);
    // turn off display test, no shutdow
    send_data(0x0F, 0);
    send_data(0x0C, 1);
}
// Hàm tăng sáng dần và giảm sáng dần trong 2 giây
void fadeLED(int pin) {
    int delayTime = 20;  // Độ trễ giữa các mức (20ms)

    // Sáng dần trong 2 giây
    for (int i = 0; i <= PWM_MAX; i++) {
        softPwmWrite(pin, i);
        delay(delayTime);
    }

    // Tối dần trong 2 giây
    for (int i = PWM_MAX; i >= 0; i--) {
        softPwmWrite(pin, i);
        delay(delayTime);
    }
}

int main(void)
{
    wiringPiSetupPhys();
    wiringPiSPISetup(spi0, 4000000);
    init_max7219();
    //thiet lap che do hoat dong OUTPUT cho cac chan (BCM)
    pinMode(red,OUTPUT);
    pinMode(green,OUTPUT);
    pinMode(blue,OUTPUT);
    pinMode(bt1,INPUT);
    pinMode(bt2,INPUT);
    pinMode(bt3,INPUT);
    pinMode(bt4,INPUT);

    //muc hoat dong LOW
    digitalWrite(red,LOW);
    digitalWrite(green,LOW);
    digitalWrite(blue,LOW);

    //muc hoat dong cua PWM tu thap den cao voi muc sang toi da la 100
    softPwmCreate(red, 0, 100);
    softPwmCreate(green, 0, 100);
    softPwmCreate(blue, 0, 100);
    while (1==1)
    {
        if (digitalRead(bt1)==1)
        digitalWrite(red,HIGH),displayHeart(heartbit);
        
        else
        digitalWrite(red,LOW);

        if (digitalRead(bt2)==1)
        digitalWrite(green,HIGH),displayHuman(human);
        else
        digitalWrite(green,LOW);

        if (digitalRead(bt3)==1)
        digitalWrite(blue,HIGH);
        else
        digitalWrite(blue,LOW);

        if (digitalRead(bt4)==1)
            for (char ch = 'A'; ch <= 'Z'; ch++) 
            {  
            displayLetter(ch);  
            sleep(1); 
            }
        /* Nut nhan sang tu thap den cao (25-100)
            if (digitalRead(bt1) == 1) {  // Nhấn SBT1 (Sáng yếu nhất)
                softPwmWrite(red, 25);
                
            }
            else if (digitalRead(bt2) == 1) {  // Nhấn BT2 (50%)
                softPwmWrite(red, 50);
                
            }
            else if (digitalRead(bt3) == 1) {  // Nhấn BT3 (75%)
                softPwmWrite(red, 75);
                
            }
            else if (digitalRead(bt4) == 1) {  // Nhấn BT4 (Sáng mạnh nhất)
                softPwmWrite(red, 100);
                
            }
            else {  // *** Nếu không nhấn nút nào -> LED TẮT ***
                softPwmWrite(red, 0);
                // softPwmWrite(green, 0);
                // softPwmWrite(blue, 0);
            }
        */
    }
    return(0);
    

}
